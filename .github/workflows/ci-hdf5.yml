name: ci-hdf5

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/ci-hdf5.yml
      - .github/actions/install-intel-fortran/*
#    branches:
#    - donotrun

jobs:
  build_prep:
    runs-on: ubuntu-latest
    steps:
      - uses: ./.github/actions/job-matrix-builder
        with:
          python_versions: '3.11,3.12'
          platforms: 'windows-latest'
          variants: 'mpi=nompi,mpi=openmpi'

  run:
    needs: build_prep
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.build_prep.outputs.final_matrix) }}
    steps:
    - uses: actions/checkout@v4

    - name: Install Intel Fortran
      uses: ./.github/actions/install-intel-fortran
      with:
        version: 2025.0.0

    - uses: prefix-dev/setup-pixi@v0.5.1
      with:
        pixi-version: v0.34.0
        cache: true

    - run: pixi run hdf5

#
#  build:
#    uses: ./.github/workflows/conda-build-basic.yml
#    with:
#      package_name: hdf5
#      conda_label: "hdf5"
#      conda_user: krande
#      python_versions: "3.12"
#      platforms: "ubuntu-latest"
#      variants: "mpi=nompi,mpi=openmpi"
#      description: "Compilations of hdf5"
#      use_intel_fortran: "True"
#      use_quetz: "True"
##      prep_script: "chmod +x /home/runner/work/condapackaging/condapackaging/src/hdf5/mpiexec.sh"
#    secrets: inherit